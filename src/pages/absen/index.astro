---
import BaseLayout from '../../layouts/BaseLayout.astro';
import TurnstileWidget from '../../components/TurnstileWidget.astro';
const presetToken = Astro.url.searchParams.get('token') ?? '';
---
<BaseLayout title="Verifikasi Absensi" description="Halaman verifikasi absensi QR MA Malnu Kananga dengan token sekali pakai.">
  <section class="card">
    <h1 class="section-title">Verifikasi Kehadiran</h1>
    <p>
      Token absensi digunakan satu kali dan hanya berlaku dalam rentang waktu tertentu. Masukkan NISN dan token yang
      diterima dari QR untuk mencatat kehadiran.
    </p>
    <form class="absen-form" aria-describedby="absen-status">
      <label>
        NISN
        <input type="text" name="nisn" required pattern="\\d{10}" inputmode="numeric" autocomplete="off" />
      </label>
      <label>
        Token
        <textarea name="token" rows="2" required>{presetToken}</textarea>
      </label>
      <TurnstileWidget action="absensi" />
      <button type="submit">Catat Kehadiran</button>
      <p id="absen-status" role="status"></p>
    </form>
  </section>
</BaseLayout>
<script>
  const form = document.querySelector('.absen-form');
  const status = document.querySelector('#absen-status');

  form?.addEventListener('submit', async (event) => {
    event.preventDefault();
    if (!(event.target instanceof HTMLFormElement) || !status) return;
    status.textContent = 'Memvalidasi token...';
    try {
      const payload = Object.fromEntries(new FormData(event.target).entries());
      const res = await fetch('/api/absen/scan', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const result = await res.json();
      if (result.success) {
        status.textContent = `Hadir tercatat pada ${new Date(result.data.waktu_scan).toLocaleString('id-ID')}`;
        event.target.reset();
      } else {
        status.textContent = result.error ?? 'Token tidak valid atau sudah digunakan.';
      }
    } catch (error) {
      console.error(error);
      status.textContent = 'Terjadi gangguan pada jaringan. Coba lagi.';
    }
  });
</script>
<style>
  .absen-form {
    display: grid;
    gap: 1rem;
  }

  input,
  textarea {
    padding: 0.75rem;
    border-radius: 1rem;
    border: 1px solid rgba(46, 125, 50, 0.25);
    background: rgba(255, 255, 255, 0.9);
  }
</style>
